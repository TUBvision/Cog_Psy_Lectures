import numpy as np
import sys
import os
import eye

id    = 'to'
sess  = 4
bdata = eye.data_to_dict('%s/%s_%d' %(id, id, sess))
edata = np.loadtxt('%s/%s_%d_eye.txt' %(id, id, sess), skiprows=1)


trl = 249
# single trial data
eye_trial = edata[edata[:,0] == trl,]

# convert eye positions from pixels into deg visual angle
points = eye.mm_to_visangle( eye.pixel_to_mm( eye_trial[:,2:4] ) )

## plot velocity_based_identification
fixations_veloc = eye.velocity_based_identification(points, velocity_threshold, min_duration, smooth_window, sampling_rate)

plt.figure()
plt.plot(points[:,0], points[:,1])
plt.plot(fixations_veloc[:,3], fixations_veloc[:,4], 'ro')

## plot dispersion_based_identification
fixations_disp = eye.dispersion_based_identification(points, dispersion_threshold, min_duration, sampling_rate)

plt.figure()
plt.plot(points[:,0], points[:,1])
plt.plot(fixations_disp[:,3], fixations_disp[:,4], 'ro')


# velocity_threshold
velocity = eye.calc_veloc(points * 1000)
velocity_smooth = eye.moving_average(velocity, sampling_rate, smooth_window, 'same')

plt.figure()
plt.plot(velocity_smooth)
plt.plot([0,1800], np.ones(2) * velocity_threshold)
velocity_smooth = eye.moving_average(velocity, sampling_rate, 40, 'same')
plt.plot(velocity_smooth)



n_items = 8
target = 0

sdata = eye.get_subset(bdata, 'target', target)
trl_select = sdata['trl'][np.logical_and(sdata['search']==0, sdata['nitems']==n_items)]


plt.figure()
for count, trl in enumerate(trl_select):
    eye_trial = edata[edata[:,0]==trl,:]
    # convert eye positions from pixels into deg visual angle
    points = eye.mm_to_visangle( eye.pixel_to_mm( eye_trial[:,2:4] ) )
    
    plt.plot(points[:,0], points[:,1])
    plt.axis([-24, 24, -15, 15])

    plt.subplot(4,5,count+1)
    plt.plot(eye_trial[:,2], eye_trial[:,3])
    plt.xlim([-500,500])
    plt.ylim([-500,500])

